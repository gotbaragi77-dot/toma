<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>지점찾기 | 광성메디멕스</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/9dc619267f.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://www.zionelab.com/assets/css/style.css" />
  <!-- ✅ 실제 JavaScript 키로 교체 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b01e52780e00b92cf39aa9715d2b0db0&libraries=services"></script>
  <style>
    body { font-family:'Pretendard','Noto Sans KR',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; margin:0; padding:0; }
    .header { position: fixed; top: 0; left: 0; width: 100%; background: #fff; z-index: 1000; border-bottom: 1px solid #eee; }
    .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 60px; display: flex; align-items: center; justify-content: space-between; height: 80px; position: relative; }
    .logo img { height: 32px; }
    .nav ul { display: flex; gap: 48px; list-style: none; align-items: center; margin: 0; padding: 0; }
    .nav li { cursor: pointer; font-weight: 500; color: #333; font-size: 15px; position: relative; padding: 0; }
    .nav li:hover { color: #0a2e26; }
    .dealer-btn { background: #0a2e26; color: #fff; padding: 10px 28px; border-radius: 20px; text-decoration: none; font-weight: 500; font-size: 14px; white-space: nowrap; }
    .dealer-btn:hover { background:#083922; color:#fff; }
    .mega-menu { position: absolute; top: 80px; left: 0; width: 100%; background: #fff; border-top: 1px solid #e5e5e5; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none; padding: 26px 0 40px 0; min-height: 400px; z-index: 999; }
    .mega-inner { max-width: 1400px; margin: 0 auto; padding: 0 60px; display: flex; justify-content: flex-start; gap: 48px; position: relative; }
    .mega-section { min-width: 120px; }
    .mega-section ul { list-style:none; margin:0; padding:0; }
    .mega-section li { margin-bottom: 14px; font-size: 13px; color: #666; transition: color 0.2s ease; white-space: nowrap; cursor: pointer; }
    .mega-section li:hover { color:#0a2e26; }
    main { margin-top:80px; }
    .sub-title { background: url('https://aplusark.mycafe24.com/assets/images/sub_bg.png') center/cover no-repeat; padding: 100px 0; text-align: center; color: #fff; position: relative; }
    .sub-title::before { content:''; position:absolute; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.3); }
    .sub-title-content { position:relative; z-index:1; }
    .sub-title h1 { font-size:42px; font-weight:700; margin-bottom:10px; }
    .sub-title p { font-size:16px; opacity:0.9; }
    .branch-section { padding:60px 0 100px 0; }
    .branch-section .container { max-width:1200px; }
    .branch-tabs { display:flex; gap:10px; margin-bottom:20px; }
    .branch-tab { padding:8px 18px; border-radius:20px; border:1px solid #ddd; background:#f9fafb; font-size:14px; cursor:pointer; }
    .branch-tab.active { background:#111827; border-color:#111827; color:#fff; }
    .branch-filters { display:flex; gap:10px; margin-bottom:16px; }
    .branch-filters select, .branch-filters input { border:1px solid #d1d5db; border-radius:6px; padding:8px 10px; font-size:13px; }
    .branch-search-btn { padding:8px 16px; border-radius:6px; border:1px solid #111827; background:#111827; color:#fff; font-size:13px; cursor:pointer; white-space:nowrap; }
    .branch-layout { display:grid; grid-template-columns: minmax(0, 360px) minmax(0, 1fr); gap:16px; }
    .branch-list-wrap { border:1px solid #e5e7eb; border-radius:8px; background:#fff; padding:16px; height:540px; display:flex; flex-direction:column; }
    .branch-total { font-size:13px; margin-bottom:8px; color:#6b7280; }
    .branch-list { list-style:none; margin:0; padding:0; overflow-y:auto; flex:1; }
    .branch-item { padding:10px 8px; border-bottom:1px solid #f3f4f6; cursor:pointer; }
    .branch-item:last-child { border-bottom:none; }
    .branch-item.active { background:#f0f9ff; }
    .branch-name { font-size:14px; font-weight:600; margin-bottom:4px; }
    .branch-addr, .branch-tel { font-size:12px; color:#4b5563; line-height:1.4; }
    #map { border-radius:8px; border:1px solid #e5e7eb; width:100%; height:540px; }
    .footer { background: #5a4a3a !important; color: #fff !important; padding: 40px 0 !important; }
    .footer-logo img { filter: brightness(0) invert(1); height: 50px; }
    .footer-copyright p { color: #ddd !important; font-size: 14px; line-height: 1.6; }
    .footer-links { display: flex; gap: 20px; margin-bottom: 15px; }
    .footer-links a { color: #fff !important; text-decoration: none; font-size: 14px; font-weight: 500; transition: opacity 0.3s; }
    .footer-links a:hover { opacity: 0.8; }
    .footer-info p { color: #ddd !important; font-size: 13px; line-height: 1.7; }
    @media (max-width: 992px) { .header-inner { padding:0 20px; } .branch-layout { grid-template-columns:1fr; } #map { height:360px; } }
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div class="logo">
      <a href="/"><img src="https://www.zionelab.com/assets/images/logo.svg" alt="ZIONE LAB 로고" /></a>
    </div>
    <nav class="nav">
      <ul class="main-menu">
        <li class="menu-item">지원랩</li>
        <li class="menu-item">브랜드소개</li>
        <li class="menu-item">제품소개</li>
        <li class="menu-item">광성메디멕스소개</li>
        <li class="menu-item">매장안내</li>
        <li class="menu-item">고객센터</li>
        <li class="menu-item">광성유통</li>
      </ul>
    </nav>
    <a href="/pages/partner/" class="dealer-btn">대리점 모집</a>
  </div>
  <div class="mega-menu">
    <div class="mega-inner" id="megaInner"></div>
  </div>
</header>
<main>
  <section class="sub-title">
    <div class="sub-title-content">
      <h1>지점찾기</h1>
      <p>가까운 지점을 검색하고 방문해보세요.</p>
    </div>
  </section>
  <section class="branch-section">
    <div class="container">
      <div class="branch-tabs mb-3">
        <button class="branch-tab active" data-cat="전체">전체</button>
        <button class="branch-tab" data-cat="광성메디멕스">광성메디멕스</button>
        <button class="branch-tab" data-cat="지원랩">지원랩</button>
      </div>
      <div class="branch-filters mb-3">
        <select id="sidoFilter"><option value="">시/도 전체</option></select>
        <select id="gugunFilter"><option value="">구/군 전체</option></select>
        <input type="text" id="keyword" placeholder="지점명 또는 주소 검색" style="flex:1; min-width:160px;" />
        <button class="branch-search-btn" id="searchBtn">검색</button>
      </div>
      <div class="branch-layout">
        <div class="branch-list-wrap">
          <div class="branch-total" id="branchTotal">총 0개의 지점이 검색되었습니다</div>
          <ul class="branch-list" id="branchList"></ul>
        </div>
        <div id="map"></div>
      </div>
    </div>
  </section>
</main>
<footer class="footer">
  <div class="container">
    <div class="row align-items-start">
      <div class="col-md-4">
        <div class="footer-logo mb-3"><img src="https://www.zionelab.com/assets/images/logo.svg" alt="광성메디멕스" /></div>
        <div class="footer-copyright">
          <p class="mb-1">Copyright © 2025</p>
          <p class="mb-0">(주)광성메디멕스. All rights reserved.</p>
        </div>
      </div>
      <div class="col-md-8">
        <div class="footer-links mb-3">
          <a href="/">HOME</a>
          <a href="#">이용약관</a>
          <a href="#">개인정보처리방침</a>
          <a href="#">사업자정보</a>
        </div>
        <div class="footer-info">
          <p class="mb-1">상호: (주)광성메디멕스 | 대표자: 장성식 | 사업자등록번호: 855-87-03219</p>
          <p class="mb-1">본사: 경기도 하남시 미사강변서로 25, 미사센스타워 지식산업센터 10층 57호</p>
          <p class="mb-0">고객센터: (T) 031.8027.2094 | (F) 070.8277.3500 | (E) zionelab@zionelab.com</p>
        </div>
      </div>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const menuData = [
    {items: ['지원랩소개', '기술력', '지원캡 900']},
    {items: ['인사말', '회사연혁', '광성기술력', '이념', '오시는길']},
    {items: ['지원돌900', '근적외선마사지기', '근적외선강공기', '근적외선케어패드', '자광석안마의자', '근적외선안마의자', '지원미샴푸', '지원미비누', '바이오셀볼륨앰플', '지원미치약', '지원미팔찌']},
    {items: ['광성메디멕스', '지원민사회', '지원돌사용기', '지원돌후용', '지원돌상']},
    {items: ['대리점안내', '지점찾기']},
    {items: ['공지사항', 'FAQ']},
    {items: ['제품소개', '제품조회']}
  ];

  $(function() {
    /* 메가메뉴 원본 로직 유지 */
    function createMegaMenu() {
      const $megaInner = $('#megaInner');
      $megaInner.empty();
      const $menuItems = $('.menu-item');
      $menuItems.each(function(i) {
        const $item = $(this);
        const position = $item.position();
        const $section = $('<div class="mega-section"></div>').css({ position: 'absolute', left: position.left });
        const $ul = $('<ul></ul>');
        (menuData[i] ? menuData[i].items : []).forEach(t => $ul.append('<li>' + t + '</li>'));
        $section.append($ul);
        $megaInner.append($section);
      });
    }
    createMegaMenu();
    $(window).resize(() => { if ($('.mega-menu').is(':visible')) createMegaMenu(); });
    $('.menu-item').mouseenter(() => { $('.mega-menu').stop(true, true).slideDown(250); createMegaMenu(); });
    $('.header').mouseleave(() => { $('.mega-menu').stop(true, true).slideUp(250); });

    /* ✅ 여기서부터 지점 데이터 로딩/표시 로직 */

    let branches = [];                       // 전체 지점 데이터
    const mapContainer = document.getElementById('map');
    let map, marker;
    let geocoder = new kakao.maps.services.Geocoder();

    function initMap() {
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      const options = { center, level: 7 };
      map = new kakao.maps.Map(mapContainer, options);
      marker = new kakao.maps.Marker({ position: center });
      marker.setMap(map);
    }

    function moveMap(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);
      marker.setPosition(pos);
    }

    // ✅ localStorage + admin/branch_data.json 불러오기
    function loadBranches() {
      const STORAGE_KEY = 'branchList';
      let localData = [];

      // 1. localStorage에서 먼저 읽기
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        localData = Array.isArray(parsed) ? parsed : [];
      } catch(e) {
        localData = [];
      }

      // 2. JSON 파일도 시도
      return fetch("admin/branch_data.json?" + Date.now())
        .then(res => {
          if (!res.ok) return localData;
          return res.json();
        })
        .then(data => {
          if (!Array.isArray(data)) return localData;

          // JSON 파일과 localStorage 데이터 병합 (중복 제거)
          const allBranches = [...localData, ...data];
          const uniqueBranches = [];
          const ids = new Set();

          allBranches.forEach(b => {
            if (!ids.has(b.id)) {
              ids.add(b.id);
              uniqueBranches.push(b);
            }
          });

          return uniqueBranches;
        })
        .catch(() => localData); // 오류 시 localStorage 데이터 반환
    }

    function buildSidoGugun(list) {
      const sidoSet = new Set();
      const gugunSet = new Set();
      list.forEach(b => {
        if (b.sido) sidoSet.add(b.sido);
        if (b.gugun) gugunSet.add(b.gugun);
      });
      const $sido = $('#sidoFilter');
      const $gugun = $('#gugunFilter');
      $sido.find('option:not(:first)').remove();
      $gugun.find('option:not(:first)').remove();
      Array.from(sidoSet).forEach(s => $sido.append('<option value="'+s+'">'+s+'</option>'));
      Array.from(gugunSet).forEach(g => $gugun.append('<option value="'+g+'">'+g+'</option>'));
    }

    function filterBranches() {
      const activeCat = $('.branch-tab.active').data('cat');
      const sido = $('#sidoFilter').val();
      const gugun = $('#gugunFilter').val();
      const keyword = $('#keyword').val().trim();

      return branches.filter(b => {
        if (activeCat !== '전체' && b.category !== activeCat) return false;
        if (sido && b.sido !== sido) return false;
        if (gugun && b.gugun !== gugun) return false;
        if (keyword) {
          const text = ((b.name || '') + ' ' + (b.fullAddr || b.addr || '')).toLowerCase();
          if (!text.includes(keyword.toLowerCase())) return false;
        }
        return true;
      });
    }

    function renderList() {
      const list = filterBranches();
      const $list = $('#branchList');
      const $total = $('#branchTotal');
      $list.empty();
      $total.text('총 ' + list.length + '개의 지점이 검색되었습니다');

      if (!list.length) {
        $list.append('<li class="branch-item">등록된 지점이 없습니다.</li>');
        return;
      }

      list.forEach((b, idx) => {
        const li = document.createElement('li');
        li.className = 'branch-item' + (idx === 0 ? ' active' : '');
        li.dataset.id = b.id;
        li.innerHTML =
          '<div class="branch-name">'+ (b.name || '') +'</div>' +
          '<div class="branch-addr">'+ (b.fullAddr || b.addr || '') +'</div>' +
          '<div class="branch-tel">'+ (b.tel || '') +'</div>';

        li.addEventListener('click', function() {
          document.querySelectorAll('.branch-item').forEach(el => el.classList.remove('active'));
          this.classList.add('active');

          if (b.lat && b.lng) {
            moveMap(b.lat, b.lng);
          } else if (b.addr) {
            geocoder.addressSearch(b.addr, function(result, status) {
              if (status === kakao.maps.services.Status.OK) {
                const lat = parseFloat(result[0].y);
                const lng = parseFloat(result[0].x);
                moveMap(lat, lng);
              }
            });
          }
        });
        $list.append(li);
      });

      const first = list[0];
      if (first) {
        if (first.lat && first.lng) {
          moveMap(first.lat, first.lng);
        } else if (first.addr) {
          geocoder.addressSearch(first.addr, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const lat = parseFloat(result[0].y);
              const lng = parseFloat(result[0].x);
              moveMap(lat, lng);
            }
          });
        }
      }
    }

    // 탭 / 필터 이벤트 그대로 유지
    $('.branch-tab').on('click', function() {
      $('.branch-tab').removeClass('active');
      $(this).addClass('active');
      renderList();
    });
    $('#searchBtn').on('click', function() { renderList(); });
    $('#sidoFilter, #gugunFilter').on('change', function() { renderList(); });

    // ✅ 초기 실행: 지도 + JSON 불러오기
    initMap();
    loadBranches().then(list => {
      branches = list;
      buildSidoGugun(branches);
      renderList();
    });
  });
</script>
</body>
</html>
